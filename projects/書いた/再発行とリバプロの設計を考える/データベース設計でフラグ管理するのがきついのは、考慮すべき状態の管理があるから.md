---
title: 
date: 
tags:
  - 0
status: 
links:
---

# 再発行、リバプロ
再発行とリバプロでフラグ管理や紐付けを外すというのをやったけど、これをやると状態とデータベースのありえるパターンが増えてしまう。それを考慮した設計をしないといけないのは、単純に苦しい

# どうふえるか？
- リバプロ
	- リードオンリーを考慮してやる
	- 他にいるならどうこうとか
- 再発行
	- 既存のLINEユーザーがいるかどうかとかで判断している？
# これまでの自分の認識
- フラグ管理するのとテーブル使い分けるのそんなに違わなくない？
	- ユースケースと状態の組み合わせがふえる。その処理がとおるときはこのデータ状態である、というのが増えると、障害の対応も難しくなる

# もうちょい考える
- 最近考えていることとして、データ状態のライフサイクルみたいなのがある
	- このデータはこう作られて、こうなって、最終はここで落ち着くかこうなる、みたいなライフサイクル
	- LINEで言うなら、
		- LINEエンジニア情報だけ作った
		- クライアント登録した
			- linkにclients, luloaとかができてる
		- メール送信した
		- 友達登録の第一弾が終わった(login/callback)
			- linkでline_users, ができて、clientsとかと繋がった
			- talk_roomsができる
		- 友達登録の第二弾（event/callbackのfollow）
			- メッセージがトークルームに入る
	- ってのがあって、さらに
		- ブロック
		- 再発行
		- リバプロ
	- みたいに状態が変わる
- ここで、この状態を管理した方がいい
	- 型で定義して、どう言う状態のやつなんだを明らかにして、それが使える関数とかも制限できる
- で、
	- 再発行はむやみに遡ってしまって、ややこしかった
	- リバプロはフラグ管理した
		- 掛け算になった時の状態認知が難しかった
		- 再発行かつ、リバプロというのが業務として発生した
		- かつ！！
			- 過去に一度でも行っているとレコードが増えて新しい状態となったのだ！！！
			- そうか１レコード内での状態に、１：Nとかの関係の状態が重なるんだ！！
			- そしてこれは実質パターン分けできない。無限に生えるから
			- フラグが悪いのではなく、フラグによってフラグでは表現できない状態の重なりが生まれることがよくない。時系列が意味を持ってしまう！！
			- リバプロ→再発行→とかってなると別の処理のように動く
- まとめると
	- 前提
		- データのどこが埋まっているとかリレーションがあるとかの、状態ってのがある
		- で、それによってできる処理、やるべき処理が異なってくる
		- ここがたくさん増えると基本的に辛い
	- 状態を表現する方法にはいくつかある
		- それ自体
			- データ状態自体で表現する。状態が変わった時に、データ状態を変える
			- 暗黙のデータ状態になっており、具体を常に意識しないといけないので、辛い
			- 型とかを使って管理してあげた方がいい
		- ステータスカラム
			- そのレコードのステータスをカラムで表現する
			- カラムがあるのでどういう状態があるのかわかって嬉しいが、これだけだと、そのステータスと実際のデータ状態がズレることがある
			- 型とかでうまいこと制限させると良い
		- テーブルを分離する
			- ステータスごとにテーブルを分ける
			- そのテーブルが持てるデータ状態が定義される
				- これは割とActiveRecord的なORMとも相性がいいのでは...？
			- 
	- さらに今回知ったこと
		- ステータスカラムによって、テーブル間の関連が変わる
			- もともと１：１だったのに１：Nとかになりうる
			- これがあると、テーブル間の関連という新しいデータ状態の次元が加わる
			- 次元が加わると、辛い
		- 次元を加えるようなステータスカラムは、テーブルを分離させた方がいい
			- メインのテーブルに関しては常にデータ状態が正常系だけになり、ステータスで分離させた異常系的なものが別のテーブルに隔離される

## さらに
- 論点がいくつかあって、
	- データ状態が一方通行であるか、それとも循環するか
		- 先祖返りをすると、すでに完了したはずのフェーズで、想定されていないデータ状態になる
		- 本来実行可能な振る舞いが実行できない
			- https://app.asana.com/1/15797530005296/project/1205290751304392/task/1209878274131952?focus=true
	- どのデータ状態にあるかをどう判定するか
		- 名付けられていないデータ状態を、データ状態そのものから判定する
		- フラグによってデータ状態を代表させる
	- フラグのデメリット
		- フラグがテーブル間のリレーションを増やすことがある
		- 有効フラグ、削除フラグみたいなやつ
			- それぞれ影響範囲としたいもの（機能とか...）が異なる、どの振る舞いに影響を与えるかの管理が大変
	- フラグの代わりにテーブルを分割する
		- けどテーブル分割ってAかつBを許容するから怖いよな
- 前提
	- データ状態によって実行できる振る舞いが異なる
		- OOP
	- それを型で制限するなどしたいというニーズ
		- データ状態から外れるものがあれば、別のデータ状態になったとして許可する振る舞いを変えたい
- てかまあ、データベースとの接合点で型があってデータを管理してくれれば問題はないよな、、データベース設計には影響ない...？
- 本来の設計としては、
	- 未発行、発行済み、登録済みのステータスしかない
	- ここで再発行すると、未発行に戻る
	- この、戻るというのがキツイ？
		- けどちゃんと状態が増えてることと手戻りしてることを意識してればどうにかなることない？
		- 今回は外部からメッセージ送信されたり既読されたりしたよね？
		- つまり、登録済みであると外部からみなされるデータが未登録になってた
		- 未登録データで登録済みのような振る舞いをしたときはエラーにしないといけなかった
		- もしくは、そんなデータにならないようにする

# 現時点の知識をまとめる
[[ステータスが循環すると凝集度が下がる]]
[[データ状態を代表させる方法]]
