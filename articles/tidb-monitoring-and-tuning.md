---
title: TiDB Cloudのモニタリングはこんなふう！ TiDB Cloud Clinicを触ってみた感想
emoji: 🐟
type: Tech
topics:
  - データベース
  - TiDB
published: false
publication_name: levtech
---
## これはなに
こんにちは、レバテック開発部のもりたです。
最近、担当システムのデータベースがAWS AuroraからTiDB Cloudに切り替わりました。やったぜ！！🥳🥳🥳　とテンションが上がったのも束の間、スロークエリが頻発したりなんだか騒がしく......。こんな時、AWS AuroraではDatabase Insightなどのモニタリング/パフォーマンスツールがあったのですが、TiDBでどうやったらいいの〜〜！？！？！😭😭😭　ということで、調べてみました。

また今回はTiDBに移行を検討しているAWS Auroraユーザの人にもわかりやすいよう、AuroraのモニタリングツールであるDatabase Insightsと適宜比較しながら説明していきます。（以下はもりたが昔書いたAuroraのモニタリングに関する記事です。読んでね）
https://zenn.dev/levtech/articles/08e2830ba2e069

# 概要
## TiDB Cloudのモニタリングには２つの方法
まず、TiDB Cloudのモニタリング方法には２つやり方があります。
１つ目がTiDB Cloudの組み込みメトリクスです。AWSにおけるCloudWatchのようなもので、基本的なよくある（けれど分散DBらしい）メトリクスが数種類並ぶ、という感じです。
２つ目がTiDB Cloud Clinicと呼ばれるツール。こちらは色々できて面白く、AWS AuroraにおけるDatabase Insights的な立ち位置のツールになります。

## 今回紹介するのはTiDB Cloud Clinic
そのTiDB Cloud Clinicですが、具体的には以下４つの機能を持っています
- メトリクス
- スロークエリ
- TOP SQL
- ベンチマークレポート

今回は上記の機能を順に触ることで、Clinicの感想を書いていこうと思います。

# TiDB Cloud Clinicを触ってみよう！
（入れられたら図）
## メトリクス
まずはメトリクスです。これはその通りメトリクスで、さまざまな指標を見ることができます。[公式ドキュメント](https://docs.pingcap.com/tidbcloud/tidb-cloud-clinic/#monitor-advanced-metrics)では見れる指標の種類が紹介されていますが、パッとタイトルを見るだけだとなにが見れるかわかりません。以下にもりたが中身をみてこんな感じかなと思ったものを置いておきます。

| 種別                    | 中身                                                               | 備考              |
| --------------------- | ---------------------------------------------------------------- | --------------- |
| Backup & Import       | 名前の通りバックアップとインポート                                                | どう使うのかはあまりわからない |
| DM-Professional       | リレーログ等が入っていたのでレプリケーション関連っぽい                                      |                 |
| DM-Standard           | 同上。プロフェッショナルとスタンダードの違いはあまりわからず                                   |                 |
| Lightning             | CPU, memory, クエリに使った時間やインポートスピードなど。どういうまとまりなのかは不明                |                 |
| Performance-Overview  | 見慣れたパフォーマンス指標に加えて、TiDBやTiKVなどのノードに関する指標も載っている                    | 見てて面白そう         |
| TiCDC-Summary         | TiCDCはTiDB→外部のMySQL互換DBのレプリケーションツール。それに関する指標群                    |                 |
| TiDB                  | 230個くらいの指標が並んでいるが、おそらくTiDBノードに関するもの                              |                 |
| TiDB-Resource-Control | Resource Unitと呼ばれるTiDBにおけるインスタンスのパワーみたいなものを見れるところだと思っています        |                 |
| TiFlash-Summary       | TiFlashは分析用クエリに強いデータストレージ。それに関する指標                               |                 |
| TiKV-Details          | TiFlashは業務用クエリに強いデータストレージ。それに関する指標                               |                 |
| TiProxy-Summary       | 公式ドキュメントには存在するが、私の環境には存在しないもの。TiProxyはTiDBノードの手前にあるコネクションを管理する機構 |                 |
| User-Node-Info        | Dosk I/Opsなどの物理的なところっぽい                                          |                 |

一応整理してみましたが、かなりの数のメトリクスがあり使いこなすのは簡単ではなさそう。ただ、こういうメトリクスを見てデータベースレイヤーの問題を早期に検出していかないといけないため、なるべく見るべきクエリのあたりをつけていきたいところです。
なお、このダッシュボードはGrafanaで管理されているようです。


内部構造しらないと分かんないもかく

## スロークエリ
これは単純なスロークエリ一覧^[300ms以上が対象で固定らしいです]です。
最大２週間を遡り、どんなスロークエリが出ていたか見ることができます。クエリごとに表示される項目はpt-query-digestと同じ^[たぶん]であり、MySQLでスロークエリを見ていた人間にとってはとっつきやすいものでした。
AWS Auroraではこのダイジェスト情報は自分で出さないといけなかったため、地味に助かると思います。

## TOP SQL
AWS AuroraのDatabase InsightsにあるTOP SQLと似たものです。表示はTiDBノードとTiKVノードごとに表示でき、２週間強遡ることができます。
Database Insightsでは負荷の種類や程度も見ることができましたが、こちらは単純にどのクエリがどれくらいの時間流れているかを出すだけです。そのため、Database InsightsのAASのような、パッと見て負荷がわかる状態ではありません。このページを見るだけで問題があるかどうかを知ることはできないようです。

## ベンチマークレポート
こちらはAWS Auroraには全くない機能で、その名の通りベンチマークのレポートを出してくれます。過去７日間を遡ることができ、期間を指定することで詳細なレポートを出力可能です。
障害が発生した際に問題がどこにあったのかなど調査に使える...？　と思いつつ、疑問なのはこのレポートがどのように出力されるのかという問題。具体的にはこのベンチマークレポートを出す際にDBに負荷がかかっているのか？　が気になりました。この点が分からないと気軽に出力できないので、公式ドキュメントなどで教えて欲しいなと思っています。

## 全体の感想

ほんまに恐れ多いんですが、まだちょっと使うのに知識と慣れがいりそうだなと思っています^[ほんまに恐れ多い。土下座しながら書いてます]。
これは自分の理解なんですが、こういったメトリクスのツールは問題が起きたあとに使うというよりは、長期的な傾向や過去のデータをもとに問題を予期するというのが一番求められることになると思います。その点、まだClinicはDatabase Insightsなどと比べて内部構造などの専門的な知識が求められる印象がありました。ただ、TiDBは現在もかなり開発が盛んみたいなので、早晩使いやすいダッシュボードが用意されるのではないかと思っています。
また、ベンチマークレポートはかなりテンションが上がりました。これを定期的に実行して問題がないかみていくのも良いかもしれません。新しい時代のスロークエリダイジェストって感じですね。

#  終わりに
TiDB Cloud Clinicの調査、楽しかったです！！
まだまだ情報も少ないので、こうやって素人の感想がたくさん集まってくれるといいなと思いました。