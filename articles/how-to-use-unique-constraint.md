---
title: ユニーク制約を運用する上での注意点、そんなにない
emoji: ⭐️
type: tech
topics:
  - unique制約
  - データベース
published: false
---
## これはなに
こんにちは、もりたです。
当方データベースが好きなのですが、データベースに関する技術や運用に関して、なんとなくで済ませているものがたくさんあります。今回はその「なんとなく」のひとつであるユニーク制約について改めて学び直してみました。

:::details 構成
## 構成
構成は以下の通り
- 基本
- ユニークをどう判断するか
- インデックスとの関係性
- アプリケーションレイヤーでの注意点
:::

それでは参りましょう。

## 基本
- まずは基本的な内容から
	- ユニーク制約とは特定のカラムにたいして設定できるデータベースの制約のこと
	- 対象のカラムが、そのテーブルの中で一意（ダブっていない）であること守らせる制約
- 適用の仕方はこう
	- {DDLの例をここに記述}
- いくつかの基本的な注意点があります
	- NULLの扱い
		- NULLを許容します。NULLのレコードは一意の制約から外れます
	- 複合ユニークキー
		- 複合インデックスのように、複数のカラムを含めてユニークであるとすることができます
	- 自己参照UPDATEができないことも
		- 自己参照するサブクエリを書く際、一時的に一意制約が成立しなくなることでクエリが失敗することがあります
## ユニークの判断に関する注意点
ユニーク制約をかけたいとき、データベースはどのようにユニークであるかどうかを判断しているのでしょうか。ここではその判断に関わる注意点をまとめます。

### collationの問題
- 文字列照合順序のcollationがユニーク制約と関係あり
	- 例えば英字の大文字小文字を区別しないものだと、その二つが区別されない状態でユニークとなる

### 長いテキスト
- 長いテキストの同一性にも限界がある
	- InnoDBでは767バイト（またはinnodb_large_prefix有効時3072バイト）が上限
	- VARCHARやTEXTの長い列には前方一致のプレフィックスインデックスを検討
### 計算結果でユニーク
- そんな機会はほぼないと思うが、同一性の問題ということで思い浮かぶのが丸め誤差など計算結果が思わぬ値になるもの
	- ユニーク制約で弾かれると思っていたのに、丸め誤差で弾かれなくなってしまうケースがあるはず
	- そんなことはほぼないと思うけど、計算するときは注意が必要

## インデックスに関する問題
- ユニークであるかどうかの判断にはインデックスを使うのがらく
	- それによって注意が必要な点がいくつかある

### ユニーク制約をつけるとインデックスも貼られる
- ユニークの判定にインデックスを使うので、インデックスが貼られる
- {試した結果を貼り付ける}

### INSERTが遅くなる
- インデックスをつけるということはINSERTが遅くなる
	- →UPDATEはどうなの

### 変更バッファが効かなくなる
- これもINSERTが遅くなる理由
	- 変更バッファとは、変更した内容を一時的にメモリ上に保存することでディスクアクセスを避けるもの
	- けど、ユニーク制約だとディスクアクセスをしないといけないから、だめ


## アプリケーション運用上の注意点
### つけるべきか、つけざるべきか
- 更新挿入頻度に鑑みて欲しい
- 割とデメリットはそれくらい

### 他の選択肢はあるか
以下はユニーク制約を回避するための方策としてWeb上で確認できた手法です。
- 事前チェック
	- そんなことするより流した方が早くない？
	- エラーになると嫌なのかな？
	- けどバリデーションで実装しそう。アプリケーションレイヤーでチェックしつつ、DBでもやってそう


## おわりに
- 整理できてよかった！


