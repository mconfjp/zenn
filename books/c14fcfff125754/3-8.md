---
title: "3-8. Development and production（開発と本番環境）"
---

# Development and production（開発と本番環境）

このページでは、Prisma Migrateコマンドを**開発環境**および**本番環境**でどのように使用するかを説明します。

## 💻 開発環境（Development environments）

開発環境では、マイグレーションを生成して適用するために **`migrate dev`** コマンドを使用します。

```bash
npx prisma migrate dev
```

### マイグレーションの作成と適用

> **🚨 危険:**
> `migrate dev` は**開発コマンド**であり、**本番環境では絶対に使用しないでください**。

このコマンドは以下のことを行います。

  * スキーマの不一致（マイグレーションファイルの編集・削除や、データベーススキーマへの手動変更）を検出するために、**シャドウデータベース**で既存のマイグレーション履歴を再実行します。
  * シャドウデータベースに保留中のマイグレーションを適用します（例：同僚が作成した新しいマイグレーション）。
  * Prismaスキーマへの変更を検出した場合、**それらの変更から新しいマイグレーションを生成**します。
  * 適用されていないすべてのマイグレーションを開発データベースに適用し、`_prisma_migrations` テーブルを更新します。
  * アーティファクト（例：Prisma Client）の生成をトリガーします。

`migrate dev` コマンドは、以下のシナリオで**データベースのリセット**を促します。

  * 変更または欠落したマイグレーションによって引き起こされる**マイグレーション履歴の競合**。
  * データベーススキーマがマイグレーション履歴の最終状態から**乖離している**（Schema Drift）。

### 開発データベースのリセット

手動での変更や `db push` による実験を取り消すために、データベースを自分でリセットすることもできます。

```bash
npx prisma migrate reset
```

> **⚠️ 警告:**
> `migrate reset` は**開発コマンド**であり、**本番環境では絶対に使用しないでください**。

このコマンドは以下のことを行います。

  * 可能であればデータベース/スキーマ¹を**ドロップ**するか、環境がデータベース/スキーマの削除を許可しない場合は**ソフトリセット**を実行します。
  * データベース/スキーマがドロップされた場合、同じ名前で新しいデータベース/スキーマ¹を**作成**します。
  * すべてのマイグレーションを**適用**します。
  * **シードスクリプトを実行**します。

¹ MySQLとMongoDBではデータベース、PostgreSQLとSQL Serverではスキーマ、SQLiteではデータベースファイルを指します。

### マイグレーションのカスタマイズ

マイグレーションを適用する前に修正する必要がある場合があります。（例：フィールド名の変更、1対1リレーションの方向変更、サポートされていない機能の追加など。）

`--create-only` コマンドを使用すると、**適用せずにマイグレーションを作成**できます。

```bash
npx prisma migrate dev --create-only
```

編集したマイグレーションを適用するには、再度 `prisma migrate dev` を実行します。

-----

## 🏭 本番・テスト環境（Production and testing environments）

本番およびテスト環境では、マイグレーションを適用するために **`migrate deploy`** コマンドを使用します。

```bash
npx prisma migrate deploy
```

> **📝 注意:**
> `migrate deploy` は通常、**自動化されたCI/CDパイプラインの一部**であるべきであり、本番データベースに変更をデプロイするためにこのコマンドをローカルで実行することは推奨しません。

このコマンドは以下のことを行います。

  * 適用済みのマイグレーションとマイグレーション履歴を比較し、**マイグレーションが修正されている場合**に警告を発します。
  * **保留中のマイグレーションを適用**します。

`migrate deploy` コマンドは、以下のことは**行いません**。

  * 既に適用済みのマイグレーションが履歴から欠落している場合に警告を発する。
  * スキーマの不一致（Schema Drift）を検出する。（例：ホットフィックスによる本番データベーススキーマとマイグレーション履歴の最終状態の不一致）
  * データベースをリセットしたり、アーティファクト（Prisma Clientなど）を生成したりする。
  * シャドウデータベースに依存する。

-----

## 🔒 助言的ロック（Advisory locking）

Prisma Migrateは、以下のような**本番コマンド**を実行する際に、\*\*助言的ロック（Advisory Locking）\*\*を利用します。

  * `prisma migrate deploy`
  * `prisma migrate dev`
  * `prisma migrate resolve`

この安全策により、複数のコマンドが同時に実行されることを防ぎます。（例：2つのプルリクエストを連続してマージする場合）。

助言的ロックには、**10秒のタイムアウト**（設定不可）があり、基盤となるプロバイダー（PostgreSQL、MySQL、Microsoft SQL server）で利用可能なデフォルトの助言的ロックメカニズムを使用します。

Prisma Migrateの助言的ロックの実装は、壊滅的なエラーを防ぐためのものであり、コマンドがタイムアウトした場合は、再実行する必要があります。

バージョン 5.3.0 以降では、環境変数 **`PRISMA_SCHEMA_DISABLE_ADVISORY_LOCK`** を使用して助言的ロックを**無効**にすることができます。
