---
title: "２-2. プリズマ・マイグレートのためのメンタルモデル"
---

## プリズマ・マイグレートのためのメンタルモデル (A mental model for Prisma Migrate)

このガイドは、リレーショナルデータベースでPrisma Migrateを使用する際のデータベースマイグレーションの**概念的な概要**を提供します。以下の内容を扱います。データベースマイグレーションとは何か、その価値、Prisma Migrateとは何か、そして異なる環境でPrisma Migrateを使ってデータベーススキーマを進化させる方法です。

**注:** MongoDBを使用している場合は、スキーマを進化させるために **`prisma db push`** を使用してください。

---

### データベースマイグレーションとは？ (What are database migrations?)

データベースマイグレーションとは、データベーススキーマの構造を**変更**し、**進化**させるための、**制御された一連の変更**のことです。

マイグレーションは、データベーススキーマを**ある状態から別の状態へ**と移行させるのに役立ちます。例えば、マイグレーション内でテーブルやカラムの作成・削除、フィールドの分割、データベースへの型や制約の追加などを行うことができます。

---

### データベーススキーマを進化させるパターン (Patterns for evolving database schemas)

データベーススキーマを進化させる主なパターンは、以下の2つです。

| パターン | 説明 |
| :--- | :--- |
| **モデル/エンティティ・ファースト (Model/Entity-first migration)** | コード（Prisma Schemaなど）でデータベーススキーマの構造を**定義**し、マイグレーションツールを使用してそこから**SQLを生成**します。 |
| **データベース・ファースト (Database-first migration)** | SQLを使用してデータベースの構造を**定義・適用**し、その後データベースを**イントロスペクト（内省）**して、データベースの構造を記述するコードを生成します。 |

**重要性：** マイグレーションファイル（SQL）はアプリケーションコードと一緒に保存し、バージョン管理で追跡され、チーム全体で共有されるべきです。これにより、データベースの**状態管理**が可能になり、特定の時点でのデータベースの状態を再現できます。

---

### Prisma Migrateとは？ (What is Prisma Migrate?)

Prisma Migrateは、**モデル/エンティティ・ファースト・マイグレーションパターン**をサポートし、ローカル環境および本番環境でデータベーススキーマを管理するデータベースマイグレーションツールです。

プロジェクトでPrisma Migrateを使用する際の**反復的なワークフロー**は以下のとおりです。

| 環境 | アクション | 使用コマンド |
| :--- | :--- | :--- |
| **ローカル開発環境** | Prismaスキーマを進化させる | **`prisma migrate dev`** または **`prisma db push`** でローカルDBと同期 |
| **プレビュー/ステージング環境** | 変更をプルリクエストにプッシュする | CIシステムで **`prisma migrate deploy`** を使用し、プレビューDBと同期 |
| **本番環境** | アプリケーションコードをメインブランチにマージする | CIシステムで **`prisma migrate deploy`** を使用し、本番DBと同期 |

---

### Prisma Migrateがマイグレーションの状態を追跡する方法 (How Prisma Migrate tracks the migration state)

Prisma Migrateは、以下の4つの要素を使用してデータベーススキーマの状態を追跡・管理します。

1.  **Prisma Schema:** データベーススキーマの構造を定義する**信頼できる唯一の情報源（Source of Truth）**。
2.  **Migrations history:** 変更履歴を表す、`prisma/migrations` フォルダ内のSQLファイル群。
3.  **Migrations table:** データベースに適用されたマイグレーションのメタデータを保存する、データベース内の **`_prisma_migrations`** テーブル。
4.  **Database schema:** データベースの現在の状態。

---

### Prisma Migrateを使う上での要件 (Requirements when working with Prisma Migrate)

* **環境ごとのデータベース:** 理想的には、開発、プレビュー、本番など、**環境ごとに個別のデータベース**を使用すべきです。
* **開発DBは使い捨て可能:** 開発環境のデータベースは簡単に作成、使用、削除できる（**使い捨て可能**）であるべきです。
* **構成の一貫性:** 各環境で使用されるデータベース構成は**一貫性**があるべきです。これにより、マイグレーションがどの環境でも同じ変更をもたらすことが保証されます。
* **Prisma Schemaは唯一の情報源:** **Prismaスキーマ**が、データベーススキーマの形を記述する**信頼できる唯一の情報源**として機能します。

---

### Prisma Migrateでデータベーススキーマを進化させる (Evolve your database schema with Prisma Migrate)

#### 1. 開発環境（ローカル）でのPrisma Migrate

##### `prisma migrate dev` でマイグレーション履歴を追跡する

**`prisma migrate dev`** コマンドは、データベースに行った変更を追跡します。

1.  SQLマイグレーションファイルを自動生成し（`/prisma/migrations` に保存）、データベースに適用します。
2.  データベースのマイグレーションテーブル（`_prisma_migrations`）を更新します。

**注:** `prisma migrate dev` は、**使い捨て可能なデータベースを持つ開発環境でのみ**の使用を意図しています。

* **スキーマの乖離（Schema Drift）の解決:**
    * スキーマの乖離は、データベーススキーマがマイグレーション履歴の内容と異なるときに発生します（例：手動でDBを更新した場合）。
    * **`prisma migrate diff`** コマンドを使用して、マイグレーション履歴と比較し、データベーススキーマの変更を元に戻す（または欠落している変更を適用する）ためのSQLを生成できます。
    * 生成したSQLは **`prisma db execute`** で適用します。
* **競合の検出:** スキーマの乖離やマイグレーション履歴の競合を検出した場合、データベースの**リセット**（ドロップして再作成）が促されます。

##### スキーマをプロトタイプ化する (`prisma db push`)

**`prisma db push`** コマンドは、マイグレーションファイル（`/prisma/migrations`）を永続化することなく、Prismaスキーマとデータベーススキーマを同期させます。

このコマンドは、以下の場合に有用です。

* **迅速なプロトタイピングとイテレーション**をローカルで行いたい場合。
* 目標とする**最終状態への到達**を優先し、そこに至るまでの手順（マイグレーションファイル）を重視しない場合。
* スキーマ変更がデータに与える影響を**制御する必要がない**場合。

**⚠️ 破壊的な変更への対応:** `prisma db push` がデータベーススキーマに対する**破壊的な変更**を検出した場合、データベースの**リセット**を促します。データ損失が伴う可能性がある場合、`--accept-data-loss` オプションで強制的に適用するか、プロセスを停止する必要があります（変更をカスタマイズする余地はありません）。

#### 2. ステージング環境と本番環境でのPrisma Migrate

##### `prisma migrate deploy` でマイグレーション履歴を同期させる

**`prisma migrate deploy`** コマンドは、開発環境からのマイグレーション履歴をステージング環境や本番環境のデータベースと同期させます。

このコマンドは、以下のことを自動で行います。

1.  すでに適用されたマイグレーションとマイグレーション履歴を比較。
2.  **保留中のマイグレーションを適用**。
3.  `_prisma_migrations` テーブルを新しいマイグレーションで更新。

このコマンドは、GitHub Actionsなどの**CI/CD環境で実行**されるべきです。

**注:** `prisma db push` を使ってマイグレーション履歴がない場合、本番環境でも `prisma db push` を使い続けることになりますが、その場合は破壊的な変更に注意し、データ損失のリスクを理解する必要があります。