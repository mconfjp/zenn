---
title: "2-３. マイグレーション履歴について"
---
## マイグレーション履歴について (About migration histories)

このページでは、Prisma ORMがスキーマへの変更を追跡するためにマイグレーション履歴をどのように使用するかを説明します。

-----

### マイグレーション履歴 (Migration history)

あなたのマイグレーション履歴は、あなたの**データモデルの変更の歴史**であり、以下の要素によって表現されます。

#### 1\. `prisma/migrations` フォルダ

マイグレーションごとにサブフォルダと `migration.sql` ファイルを持つ `prisma/migrations` フォルダです。

```
migrations/
└─ 20210313140442_init/
    └─ migration.sql
└─ 20210313140442_added_job_title/
    └─ migration.sql
```

この **`migrations` フォルダ**こそが、\*\*データモデルの履歴に関する信頼できる唯一の情報源（Source of Truth）\*\*です。

#### 2\. データベース内の `_prisma_migrations` テーブル

データベース内の **`_prisma_migrations` テーブル**は、以下のことを確認するために使用されます。

  * マイグレーションがデータベースに対して実行されたかどうか。
  * 適用されたマイグレーションが削除されたかどうか。
  * 適用されたマイグレーションが変更されたかどうか。

マイグレーションを変更または削除した場合（**非推奨**）、次のステップは、開発環境（`migrate dev` を使用）か、本番/テスト環境（`migrate deploy` を使用）かによって異なります。

-----

### ⚠️ 適用済みのマイグレーションを編集・削除しないでください (Do not edit or delete migrations that have been applied)

一般に、**すでに適用されたマイグレーションを編集したり削除したりすべきではありません。**

これを行うと、開発環境と本番環境のマイグレーション履歴の間に**不整合**が生じる可能性があり、その変更が最初は何も壊さないように見えても、**予期せぬ結果**を招く可能性があります。

> **シナリオの例：**
>
> 開発環境で既に適用済みのマイグレーションを編集し、あるカラムの型を `VARCHAR(550)` から `VARCHAR(560)` に変更したとします。
>
> 1.  **`prisma migrate dev`** を実行すると、マイグレーションが変更されたというエラーが発生し、データベースのリセットが提案されます。
> 2.  **`prisma migrate reset`** を実行すると、データベースがリセットされ、編集されたマイグレーションを含むすべてのマイグレーションが再実行されます。
> 3.  すべての既存マイグレーションの適用後、Prisma Migrateは履歴の最終状態をPrismaスキーマと比較し、不一致を検出します（履歴の最終状態は `VARCHAR(560)`、Prismaスキーマは `@db.VarChar(550)`）。
> 4.  履歴の最終状態がPrismaスキーマと一致すべきであるため、Prisma Migrateは値を `550` に戻す**新しいマイグレーションを生成**します。
> 5.  その後、本番環境にデプロイするために **`prisma migrate deploy`** を実行するたびに、スキーマの最終状態は一致していても、「マイグレーション履歴が一致しない」という**警告が継続して表示され続けます**。
>
> **結論：** リセット後に何も問題ないように見える変更でも、特に高度にカスタマイズされたマイグレーションの場合、**開発環境では再現できない本番環境のバグ**につながる可能性があります。
>
> Prisma Migrateが**欠落したマイグレーション**や**編集されたマイグレーション**を報告した場合、リセットするのではなく、\*\*根本原因を修正すること（ファイルを復元するか、変更を元に戻すこと）\*\*を推奨します。

-----

### ソース管理へのマイグレーション履歴のコミット (Committing the migration history to source control)

**`prisma/migrations` フォルダ全体**をソース管理（Gitなど）にコミットする必要があります。これには、プロバイダー変更の試みを検出するために使用される **`prisma/migrations/migration_lock.toml`** ファイルも含まれます。

`schema.prisma` ファイルだけをソース管理に入れるだけでは不十分です。マイグレーション履歴を含める必要があるのは以下の理由からです。

  * マイグレーションをカスタマイズし始めると、マイグレーション履歴には**Prismaスキーマでは表現できない情報**が含まれるようになります（例：破壊的な変更によって引き起こされるデータ損失を軽減するためのカスタマイズ）。
  * ステージング、テスト、本番環境に変更をデプロイするために使用される **`prisma migrate deploy`** コマンドは、**マイグレーションファイルのみを実行**します。モデルを取得するためにPrismaスキーマ自体を使用することはありません。