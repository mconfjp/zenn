---
title: "3-3. データベースのベースライニング "
---

# Baselining a database（データベースのベースライニング）

**ベースライニング**とは、以下の両方の条件を満たす**既存のデータベース**に対して、マイグレーション履歴を初期化するプロセスです。

✔ Prisma Migrateを使い始める**前から存在していた**。
✔ **維持しなければならないデータ**（本番環境など）を含んでおり、**データベースをリセットできない**。

ベースライニングを行うことで、Prisma Migrateに対して**1つ以上のマイグレーションが既に適用されている**とみなすように指示します。これにより、生成されたマイグレーションが、既に存在するテーブルやフィールドを作成しようとして失敗するのを防ぎます。

> **📝 注意:** 開発データベースについては、リセットとシード（データの初期投入）が許容されることを前提としています。

ベースライニングは、**既存のデータベースを持つプロジェクトにPrisma Migrateを追加する**プロセスの一部です。

> **⚠️ 警告**
> このガイドは **MongoDBには適用されません**。MongoDBでは `migrate deploy` の代わりに `db push` が使用されます。

-----

## 💡 ベースラインが必要な理由

既存のプロジェクトにPrisma Migrateを追加する場合、最初のマイグレーションには、Prisma Migrateを使い始める前のデータベースの状態を**再現するために必要なすべてのSQL**が含まれます。

> **💡 ヒント**
> ストアドプロシージャやトリガーなど、Prismaスキーマでは表現できないスキーマ要素を含めるために、この初期マイグレーションを編集することができます。

この初期マイグレーションは、**開発環境を作成・リセットするため**に必要です。

しかし、**既に存在し、リセットできないデータベース**（本番環境など）にマイグレーションを `prisma migrate deploy` する場合、初期マイグレーションを含めたくありません。ターゲットデータベースには既に初期マイグレーションによって作成されたテーブルやカラムが含まれているため、それらの要素を再度作成しようとすると、ほぼ確実にエラーが発生します。

**ベースライニング**は、初期マイグレーションが**既に適用されているとPrisma Migrateに思い込ませる**ことで、この問題を解決します。

-----

## 🛠️ データベースをベースライン化する

ベースラインマイグレーションを作成する手順は以下の通りです。

1.  `prisma/migrations` フォルダがある場合は、そのフォルダを削除、移動、名前変更、またはアーカイブしてください。

2.  以下のコマンドを実行して、任意の名前でマイグレーションディレクトリを作成します。この例では `0_init` を使用します。

    ```bash
    mkdir -p prisma/migrations/0_init
    ```

    > **ℹ️ 情報**
    > `0_` は重要です。なぜなら、Prisma Migrateは[辞書順](https://www.google.com/search?q=https://www.prisma.io/docs/orm/prisma-migrate/understanding-prisma-migrate%23lexicographical-order)でマイグレーションを適用するからです。現在のタイムスタンプなど、異なる値を使用することもできます。

3.  `prisma migrate diff` を使用してマイグレーションを生成し、ファイルに保存します。

    ```bash
    npx prisma migrate diff \
      --from-empty \
      --to-schema-datamodel prisma/schema.prisma \
      --script > prisma/migrations/0_init/migration.sql
    ```

4.  **無視すべき（既に適用されているとみなすべき）マイグレーション**ごとに、`prisma migrate resolve` コマンドを実行します。

    ```bash
    npx prisma migrate resolve --applied 0_init
    ```

    このコマンドは、対象のマイグレーションを **`_prisma_migrations` テーブルに追加し、**「適用済み」としてマークします。

新しいマイグレーションを適用するために `prisma migrate deploy` を実行すると、Prisma Migrateは以下の動作をします。

  * **「適用済み」とマークされたすべてのマイグレーション**（ベースラインマイグレーションを含む）を**スキップ**します。
  * ベースラインマイグレーションより**後に来る新しいマイグレーション**を**適用**します。
