---
title: "3-5-1. Squashing migrations（マイグレーションのスカッシュ）"
---

# Squashing migrations（マイグレーションのスカッシュ）

このガイドでは、**複数のマイグレーションファイルを1つのマイグレーションにまとめる（スカッシュする）方法**について説明します。

## ℹ️ マイグレーションのスカッシュについて

一部またはすべてのマイグレーションファイルを1つにまとめることは、時に役立ちます。このガイドでは、スカッシュを行う2つのシナリオを説明します。

  * **ローカルのマイグレーション**をマージする前に1つにまとめ、**開発環境からクリーンに移行する**場合。
  * すべてのマイグレーションを単一ファイルにまとめ、**本番環境でクリーンな履歴を作成する**場合。

どちらのケースでも、Prisma Migrateは **`migrate diff`** コマンドを使用して、2つのデータベーススキーマを比較し、一方から他方へ移行するための単一のSQLファイルを出力することで、スカッシュのツールを提供します。

> **⚠️ 警告: スカッシュ時の考慮事項**
> マイグレーションをスカッシュする際、`migration.sql` ファイルに**手動で変更または追加されたカスタムSQLは保持されません**。ビューやトリガーなど、カスタムな追加が含まれるマイグレーションファイルがある場合は、スカッシュ後に**必ずそれらを再追加**してください。

-----

## 🛠️ シナリオ 1: 開発環境からクリーンに移行する

ブランチベースのワークフローで開発する場合に、スカッシュが役立ちます。

フィーチャーブランチでの大規模なローカル開発中に、`migrate dev` を使用して複数のマイグレーションが生成されることがあります。フィーチャーが完了した後、マイグレーション履歴には、最終的にメインブランチにプッシュしたくない**不必要な中間ステップ**が含まれている可能性があります。

これらの**中間ステップを本番環境に適用するのを避けるべき重要な理由がある**場合（データ損失を引き起こしたり、非常に遅かったりする場合）や、単純に本番環境のマイグレーション履歴の**煩雑さを避けたい**場合に有効です。

### 手順

スカッシュを開始する前に、以下の初期条件が満たされていることを確認してください。

  * スカッシュするマイグレーションの内容は、**まだ本番データベースに適用されていない**。
  * 本番に適用済みのすべてのマイグレーションは、**既にローカルのマイグレーション履歴の一部**である。
  * ブランチに追加した新しいマイグレーションファイルに**カスタムSQLが含まれていない**。

> **ℹ️ 情報**
> フィーチャーブランチを作成した後、本番データベースのマイグレーション履歴が分岐している場合は、まず本番からのマイグレーション履歴とデータモデルの変更をローカル履歴にマージする必要があります。

以下の手順を実行します。

1.  ローカルの `./prisma/migrations` フォルダの内容を、\*\*メインブランチのマイグレーション履歴に一致するようにリセット（または削除）\*\*します。
2.  **新しいマイグレーションを作成**します。
    ```bash
    npx prisma migrate dev --name squashed_migrations
    ```
    これにより、\*\*リセットされたマイグレーション履歴（メインブランチの状態）\*\*から、\*\*ローカルフィーチャーの状態（`./prisma/schema.prisma` ファイルで記述されている状態）\*\*への変更を反映した単一のマイグレーションが作成され、新しいディレクトリの `migration.sql` ファイルに出力されます。

この単一のマイグレーションファイルは、**`migrate deploy` を使用して本番環境に適用**できます。

-----

## 🧹 シナリオ 2: 本番環境でクリーンな履歴を作成する

本番環境でマイグレーションをスカッシュすることもできます。これは、本番環境でマイグレーション履歴が長くなり、中間ステップのために**新しい環境でのリプレイに時間がかかる**ようになった場合に役立ちます。チームが個々のマイグレーションステップから価値を得ていない（そして、必要であればバージョン管理の履歴から復元できる）と判断した場合、履歴全体を単一のマイグレーションにスカッシュすることができます。

### 手順

スカッシュを開始する前に、以下の初期条件が満たされていることを確認してください。

  * マイグレーション履歴内の**すべてのマイグレーションが本番データベースに適用されている**。
  * データモデルがマイグレーション履歴と一致している（**同期している**）。

以下の手順を実行します。

1.  メインブランチ、または新しくチェックアウトしたブランチ（他の変更が加えられる前にメインにマージされる）で作業します。

2.  `./prisma/migrations` ディレクトリの**すべての内容を削除**します。

3.  `./prisma/migrations` ディレクトリ内に**新しい空のディレクトリ**を作成します。この例では `000000000000_squashed_migrations` とします。その中に**新しい空の `migration.sql` ファイル**を追加します。

    > **ℹ️ 情報**
    > このマイグレーションには、すべての先行ゼロを持つ名前を付けています。これは、マイグレーションディレクトリ内で**最初のマイグレーション**にしたいためです。Migrateは辞書順（アルファベット順）にマイグレーションを実行します。

4.  **単一のマイグレーションを作成**します。
    以下のコマンドを使用して、**空のデータベース**から\*\*現在の本番データベーススキーマの状態（`./prisma/schema.prisma` で記述されている状態）\*\*への変更を反映した単一のマイグレーションを作成し、作成した `migration.sql` ファイルに出力します。

    ```bash
    npx prisma migrate diff \
      --from-empty \
      --to-schema-datamodel ./prisma/schema.prisma \
      --script > ./prisma/migrations/000000000000_squashed_migrations/migration.sql
    ```

5.  このマイグレーションが**既に本番環境に適用済みであるとマーク**し、本番環境で実行されないようにします。
    `migrate resolve` コマンドを使用して、このマイグレーションを「適用済み」としてマークします。

    ```bash
    npx prisma migrate resolve \
      --applied 000000000000_squashed_migrations
    ```

これで、本番環境に適用済みとしてマークされた単一のマイグレーションファイルが作成されました。新しいチェックアウトでは、単一のマイグレーションのみが実行され、本番データベーススキーマの状態に到達できます。

  * 本番データベースには、依然として**適用済みのマイグレーションの履歴**が `_prisma_migrations` テーブルに残っています。
  * マイグレーションフォルダとデータモデルの履歴も、**ソース管理（Gitなど）で引き続き利用可能**です。
