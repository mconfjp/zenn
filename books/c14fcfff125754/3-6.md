---
title: "3-6. Patching & hotfixing（パッチ適用とホットフィックス）"
---

# Patching & hotfixing（パッチ適用とホットフィックス）

データベースへのパッチ適用やホットフィックスは、多くの場合、**本番環境で直接、時間的に重要な変更**を行うことを含みます。例えば、実行の遅いクエリの問題を解決するために、本番データベースに直接インデックスを追加する場合があります。

本番データベースに直接パッチを適用すると、\*\*スキーマの不一致（Schema Drift）**が発生します。つまり、データベーススキーマが信頼できる情報源（Prismaスキーマとマイグレーション履歴）から**「乖離」\*\*し、同期が取れなくなります。

`prisma migrate resolve` コマンドを使用すると、**`prisma migrate deploy` でホットフィックスを削除して再適用することなく**、マイグレーション履歴をデータベースと**整合**させることができます。

> **⚠️ 警告:**
> このガイドは **MongoDBには適用されません**。MongoDBでは `migrate dev` の代わりに `db push` が使用されます。

-----

## 🤝 パッチまたはホットフィックスによるマイグレーション履歴の整合

このシナリオでは、本番環境で手動で変更を行い、その変更をマイグレーション履歴と他のデータベースに反映させたい場合を想定しています。

本番環境のマイグレーション履歴とデータベーススキーマを整合させる手順は以下の通りです。

1.  **スキーマ内で変更を再現する:**
    本番環境で行った変更を `schema.prisma` ファイルに反映させます。（例：特定のモデルに `@@index` を追加する。）

2.  **新しいマイグレーションを生成する:**
    以下のコマンドを実行し、**タイムスタンプを含む完全なマイグレーション名**をメモします。（例: `20210316150542_retroactively_add_index`）。

    ```bash
    npx prisma migrate dev --name retroactively-add-index
    ```

    この時点で、開発データベースはスキーマと同期しています。

3.  **`migrate resolve` を使用して本番にプッシュする:**
    `migrate deploy` を実行するのではなく、前のステップで作成したマイグレーションを\*\*「既に適用済み」としてマーク\*\*します。これにより、Prisma Migrateがホットフィックスを二度適用しようとするのを防ぎます。

    ```bash
    npx prisma migrate resolve --applied "20201127134938-retroactively-add-index"
    ```

    このコマンドは、**実際のSQLを実行せずに**マイグレーションを `_prisma_migrations` テーブルに追加します。

4.  **他のデータベースへの反映:**

      * パッチを適用した**他のデータベース**（例：ステージングデータベース）についても、前のステップを繰り返します。
      * パッチを適用**していない他のデータベース**（例：新しい開発環境）には、マイグレーションをソース管理にコミットし、CI/CDパイプラインなどで適用させます。

-----

## ❌ 失敗したマイグレーションの修正

マイグレーションは、以下のような場合に失敗する可能性があります。

  * 実行前にマイグレーションを修正し、構文エラーを導入した。
  * 既にデータがあるテーブルに必須（`NOT NULL`）カラムを追加した。
  * マイグレーションプロセスが予期せず停止した。
  * データベースがマイグレーションプロセスの途中でシャットダウンした。

`_prisma_migrations` テーブルの `logs` カラムには、エラーが保存されています。

本番環境で失敗したマイグレーションに対処する方法は主に2つあります。

### オプション 1: ロールバックとしてマークして再デプロイ

1.  **マイグレーションをロールバックとしてマークする:**
    `_prisma_migrations` テーブルのマイグレーションレコードをロールバック済みとして登録し、再適用できるようにします。
    ```bash
    npx prisma migrate resolve --rolled-back "20201127134938_added_bio_index"
    ```
      * **部分的に実行された場合:** マイグレーションを修正してステップが既に完了しているかチェックするか（例: `CREATE TABLE ... IF NOT EXISTS`）、完了したステップを**手動で元に戻します**。
2.  **失敗の根本原因を修正する:**
    SQLスクリプトの問題など、失敗の原因を修正します。変更したマイグレーションはソース管理にコピーしてください。
3.  **マイグレーションを再デプロイする:**
    ```bash
    npx prisma migrate deploy
    ```

### オプション 2: 手動で完了させて「適用済み」として解決

1.  **本番データベースでマイグレーションステップを手動で完了させる:**
    手動で行ったステップがマイグレーションファイル内のステップと**完全に一致すること**を確認し、変更をソース管理にコピーします。
2.  **マイグレーションを「適用済み」として解決する:**
    Prisma Migrateに、このマイグレーションが正常に適用されたとみなすように指示します。
    ```bash
    npx prisma migrate resolve --applied "20201127134938_my_migration"
    ```

-----

## 🔧 `migrate diff` と `db execute` による修正

失敗したマイグレーションの修正を支援するために、Prisma ORMは以下のコマンドを提供しています。

  * **`prisma migrate diff`**: 2つのデータベーススキーマソースを比較し、一方を他方の状態にするためのマイグレーション（SQLスクリプトまたは差分の概要）を作成します。
  * **`prisma db execute`**: Prismaマイグレーションテーブルと連携せずに、SQLスクリプトをデータベースに適用します。

### 失敗したマイグレーションの例と修正

（例として、`User` モデルの `name` フィールドを一意（`@unique`）にするマイグレーションが、本番環境の重複データにより失敗した場合を考えます。）

#### ⬅️ 遡ってすべての変更を元に戻す

非一意なデータが有効であり、現在の開発を進められないと判断した場合、マイグレーション全体をロールバックする必要があります。

1.  **ロールバック用SQLスクリプトを作成する:**
    現在の\*\*失敗した状態（`--from-url`）**から、失敗前の**マイグレーション履歴の状態（`--to-migrations`）\*\*に戻るために必要なすべての変更を含むSQLスクリプトを作成します。

    ```bash
    npx prisma migrate diff \
      --from-url "$DATABASE_URL_PROD" \
      --to-migrations ./prisma/migrations \
      --shadow-database-url $SHADOW_DATABASE_URL \
      --script > backward.sql
    ```

2.  **SQLスクリプトを実行する:**

    ```bash
    npx prisma db execute --url "$DATABASE_URL_PROD" --file backward.sql
    ```

3.  **マイグレーションをロールバックとして解決する:**

    ```bash
    npx prisma migrate resolve --rolled-back Unique
    ```

    これで、ローカルのマイグレーション履歴が本番データベースの状態と同じになり、非一意な名前を許可するようにデータモデルを修正できます。

#### ➡️ 前進して不足している変更を適用する

データベース内の非一意なデータが意図しないものであり、それを修正してからマイグレーションを進めたい場合です。

1.  **重複データを修正する:**
    エラーメッセージに基づいて、重複データを含む行を手動で修正または削除します。

2.  **不足している変更用のSQLスクリプトを作成する:**
    現在の\*\*失敗した状態（`--from-url`）**から、`schema.prisma` ファイルで定義された**目標状態（`--to-schema-datamodel`）\*\*に進むために必要なすべての変更を含むSQLスクリプトを作成します。

    ```bash
    npx prisma migrate diff --from-url "$DATABASE_URL_PROD" --to-schema-datamodel schema.prisma --script > forward.sql
    ```

3.  **SQLスクリプトを実行する:**

    ```bash
    npx prisma db execute --url "$DATABASE_URL_PROD" --file forward.sql
    ```

4.  **マイグレーションを「適用済み」として解決する:**

    ```bash
    npx prisma migrate resolve --applied Unique
    ```

    これで、ローカルのマイグレーション履歴が本番環境の状態と同じになり、通常の `migrate dev / migrate deploy` ワークフローを続行できます。
