---
title: "3-12. Troubleshooting（トラブルシューティング）"
---

# Troubleshooting（トラブルシューティング）

このガイドでは、**開発環境**におけるPrisma Migrateの問題を解決する方法について説明します。多くの場合、これにはデータベースのリセットが伴います。

> **⚠️ 警告:**
> このガイドは **MongoDBには適用されません**。MongoDBでは `migrate dev` の代わりに `db push` が使用されます。

## ⚠️ マイグレーション履歴の競合の処理

**マイグレーション履歴の競合**は、ファイルシステム内の `migrations` フォルダと、データベース内の `_prisma_migrations` テーブルの間に不一致がある場合に発生します。

### 競合の原因（開発環境）

  * 既に適用されたマイグレーションが、後で**修正された**。
  * 既に適用されたマイグレーションが、ファイルシステムから**欠落している**。
  * 開発環境では、フィーチャーブランチ間の切り替えが競合を引き起こす可能性があります。（例：`branch-1` のマイグレーションが `_prisma_migrations` テーブルに含まれているが、`branch-2` に切り替えるとそれらが消える場合。）

> **📝 注意:** 開発と本番環境の間で不一致が生じる可能性があるため、マイグレーションを故意に削除したり編集したりすべきではありません。

### 競合の解決（開発環境）

`prisma migrate dev` の実行時にPrisma Migrateが競合を検出した場合、CLIは**データベースをリセットしてマイグレーション履歴を再適用**するように求めます。

-----

## 📉 スキーマの不一致（Schema drift）

\*\*スキーマの不一致（Schema drift）\*\*は、データベーススキーマがマイグレーション履歴と同期していない状態、つまり、データベーススキーマが信頼できる情報源から「乖離している」場合に発生します。

### スキーマの不一致の原因（開発環境）

  * マイグレーションを使用せずにデータベーススキーマが変更された場合。（例：`prisma db push` を使用したり、データベーススキーマを手動で変更したりした場合。）

> **📝 注意:** スキーマの不一致の検出には**シャドウデータベース**が必要であり、そのため開発環境でのみ可能です。

### スキーマの不一致の解決（開発環境）

#### **変更を破棄して同期をやり直す場合**

手動で行った変更を保持したくない場合、またはPrismaスキーマで簡単に再現できる場合は、以下の手順を実行します。

1.  **データベースをリセットします。**
    ```bash
    npx prisma migrate reset
    ```
2.  **変更をPrismaスキーマに反映させ、新しいマイグレーションを生成します。**
    ```bash
    npx prisma migrate dev
    ```

#### **変更を保持してマイグレーション履歴に含める場合**

手動で行った変更を保持したい場合は、以下の手順を実行します。

1.  **データベースをイントロスペクト（内省）します。**
    ```bash
    npx prisma db pull
    ```
    Prismaは、データベースで直接行われた変更を反映するようにスキーマを更新します。
2.  **新しいマイグレーションを生成します。**
    ```bash
    npx prisma migrate dev --name introspected_change
    ```
    Prisma Migrateはリセットを促した後、既存のすべてのマイグレーションと、イントロスペクトされた変更に基づく新しいマイグレーションを適用します。これにより、データベースとマイグレーション履歴は手動の変更を含めて同期されます。

-----

## 💥 失敗したマイグレーション

### 失敗の原因（開発環境）

  * 実行前にマイグレーションを修正し、**SQL構文エラー**を導入した。
  * 既にデータがあるテーブルに**必須（`NOT NULL`）カラム**を追加するなど、データベースにデータがあるために適用できないPrismaスキーマの変更を導入した。
  * マイグレーションプロセスが予期せず停止した、またはデータベースがマイグレーションプロセスの途中でシャットダウンした。

各マイグレーションの `_prisma_migrations` テーブルの `logs` カラムにはエラーが保存されます。

### 失敗の解決（開発環境）

開発環境で失敗したマイグレーションを処理する最も簡単な方法は、**根本原因に対処し、データベースをリセットすること**です。

1.  **SQL構文エラーの場合:**
    失敗した `migration.sql` ファイルを更新してエラーを修正し、データベースをリセットします。

    ```bash
    prisma migrate reset
    ```

2.  **データが存在するテーブルへの必須カラムの追加など、データの問題の場合:**

      * 失敗した `migration.sql` ファイルを削除します。
      * スキーマを修正します。（例：必須フィールドにデフォルト値を追加する。）
      * マイグレーションを実行します。

    <!-- end list -->

    ```bash
    prisma migrate dev
    ```

    Prisma Migrateはデータベースをリセットしてすべてのマイグレーションを再適用するように促します。

3.  **マイグレーションプロセスが中断した場合:**

      * データベースをリセットします。

    <!-- end list -->

    ```bash
    prisma migrate reset
    ```

-----

## 🔗 Prisma MigrateとPgBouncer

接続プーリングに **PgBouncer** を使用する環境でPrisma Migrateコマンドを実行しようとすると、以下のエラーが発生する場合があります。

```
Error: undefined: Database error
Error querying the database: db error: ERROR: prepared statement "s0" already exists
```

詳細と回避策については、[Prisma Migrate and PgBouncer workaround](https://github.com/prisma/prisma/issues/6485)を参照してください。
