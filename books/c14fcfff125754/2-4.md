---
title: "2-４. シャドウデータベースについて"
---

## シャドウデータベースについて (About the shadow database)

シャドウデータベースは、**一時的な2番目のデータベース**です。`prisma migrate dev` を実行するたびに自動的に作成および削除されます\*（\*一部のデータベースを除きます）。これは主に、**スキーマの乖離（schema drift）や、生成されたマイグレーションによる潜在的なデータ損失**などの問題を検出するために使用されます。

`migrate diff` コマンドも、`--from-migrations` または `--to-migrations` を指定してローカルのマイグレーションディレクトリと比較する場合にシャドウデータベースを必要とします。

データベースが（クラウドホスト型環境などで）データベースの作成と削除を許可していない場合は、シャドウデータベースを**手動で作成および構成**する必要があります。

**⚠️ 警告:** シャドウデータベースは**本番環境では不要**であり、`prisma migrate resolve` や `prisma migrate deploy` のような本番環境向けのコマンドでは使用されません。

**📝 注:** MongoDBでは `migrate dev` が使用されないため、シャドウデータベースは**一切使用されません**。

-----

### シャドウデータベースの仕組み (How the shadow database works)

`prisma migrate dev` を実行して新しいマイグレーションを作成するとき、Prisma Migrateはシャドウデータベースを使用して以下のことを行います。

1.  **スキーマの乖離を検出する:** 開発データベースに予期せぬ変更（手動での変更など）が行われていないかを確認します。
2.  **新しいマイグレーションを生成する:** 生成されたマイグレーションを適用した際にデータ損失につながる可能性があるかどうかを評価します。

#### スキーマの乖離の検出

開発環境で乖離を検出するために、Prisma Migrateは以下の手順を実行します。

1.  シャドウデータベースの**まっさらなコピーを作成**します。
2.  シャドウデータベース内で、**現在の既存のマイグレーション履歴をすべて再実行**します。
3.  シャドウデータベースを**イントロスペクト（内省）し、マイグレーション履歴に基づく「現在の状態」のPrismaスキーマ**を生成します。
4.  このマイグレーション履歴の最終状態を**開発データベースの状態と比較**します。
5.  履歴の最終状態と開発データベースが一致しない場合（例：手動での変更が原因）、**スキーマの乖離を報告**します。

**注:** シャドウデータベースは、マイグレーションファイルが編集または削除されたかどうかのチェックは担当しません。これは `_prisma_migrations` テーブルのチェックサムフィールドを使用して行われます。

#### 新しいマイグレーションの生成

スキーマの乖離が検出されなかった場合、Prisma MigrateはPrismaスキーマの変更から新しいマイグレーションの生成に進みます。

1.  現在のPrismaスキーマから**ターゲットデータベーススキーマ**を計算します。
2.  既存のマイグレーション履歴の最終状態とターゲットスキーマを比較し、\*\*その間を埋めるステップ（差分）\*\*を生成します。
3.  これらのステップをSQL文字列としてレンダリングし、**新しいマイグレーションファイルに保存**します。
4.  生成されたSQLによる**データ損失を評価し、警告**します。
5.  生成されたマイグレーションを開発データベースに適用します（`--create-only` フラグを指定しない場合）。
6.  シャドウデータベースを削除します。

-----

### シャドウデータベースの手動構成 (Manually configuring the shadow database)

データベースの作成と削除が許可されていない場合（クラウドホスト型データベースなど）、`migrate dev` のシャドウデータベースとして使用する接続文字列とデータベース名を**手動で定義**できます。

その場合は、以下の手順を実行します。

1.  シャドウデータベースとして使用する**専用のデータベースを手動で作成**します。
2.  そのデータベースの接続文字列を環境変数 **`SHADOW_DATABASE_URL`** に追加します（または `.env` ファイルに設定します）。
3.  `schema.prisma` の `datasource` ブロックに、この環境変数を読み込む **`shadowDatabaseUrl`** フィールドを追加します。

<!-- end list -->

```prisma
datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}
```

**🚨 重要:** `url` と `shadowDatabaseUrl` に**全く同じ値を使用しないでください**。データがすべて削除される可能性があります。

-----

### シャドウデータベースのユーザー権限 (Shadow database user permissions)

`migrate dev` を使用してシャドウデータベースを自動で作成・削除できるようにするには、`datasource` で定義されているデータベースユーザーに**データベース作成の権限**が必要です。

| データベース | ユーザーの要件（抜粋） |
| :--- | :--- |
| **PostgreSQL** | ユーザーはスーパーユーザーであるか、`CREATEDB` 権限を持っている必要があります。 |
| **MySQL/MariaDB** | ユーザーは `CREATE, ALTER, DROP, REFERENCES ON *.*` の権限を持っている必要があります。 |

**エラーの解決策:**

資格情報でシャドウデータベースを作成できないというエラーが発生した場合、以下のいずれかを実行してください。

  * ローカルで作業している場合は、**データベースユーザーの権限を更新**します。
  * データベースの作成と削除が許可されていない場合は、「**シャドウデータベースの手動構成**」を参照してください。
  * 生成されたマイグレーションファイルに関心がなく、スキーマを迅速に適用したいだけの場合は、`prisma migrate dev` の代わりに **`prisma db push`** コマンドを実行することを検討してください。

**重要:** シャドウデータベースは開発環境（特に `prisma migrate dev` コマンド）でのみ必要であり、**本番環境で変更を加える必要はありません。**