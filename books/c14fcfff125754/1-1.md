---
title: "1-1. Getting started with Prisma Migrate"
---

# Prisma Migrate の導入

このページでは、Prisma Migrate を使用して、**開発環境でスキーマをマイグレーション（移行）する方法**の概要を説明します。

## ⚙️ Prisma Migrateをゼロから始める

開発環境でPrisma Migrateを始める手順は以下の通りです。

### 1\. Prismaスキーマを作成する

まず、`schema.prisma` ファイルにデータソースとモデルを定義します。

```prisma
schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    Int     @id @default(autoincrement())
  name  String
  posts Post[]
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  published Boolean @default(true)
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
}
```

> **💡 ヒント**
> スキーマ内でネイティブ型マッピング属性を使用すると、作成する正確なデータベース型を決定できます（例：`String` を `varchar(100)` や `text` にマッピングできます）。

### 2\. 最初のマイグレーションを作成する

次のコマンドを実行すると、Prismaスキーマに基づいてデータベースに変更を適用し、最初のマイグレーション履歴が作成されます。

```bash
prisma migrate dev --name init
```

これでPrismaスキーマはデータベーススキーマと同期され、マイグレーション履歴が初期化されました。

```
migrations/
└─ 20210313140442_init/
└─ migration.sql
```

### 3\. スキーマに追加のフィールドを追加する

`User` モデルに `jobTitle` フィールドを追加するなど、スキーマに変更を加えます。

```prisma
model User {
  id          Int     @id @default(autoincrement())
  jobTitle    String // ← 追加されたフィールド
  name        String
  posts       Post[]
}
// ...
```

### 4\. 2番目のマイグレーションを作成する

再度 `prisma migrate dev` を実行し、変更をデータベースに適用し、新しいマイグレーション履歴を作成します。

```bash
prisma migrate dev --name added_job_title
```

Prismaスキーマは再びデータベーススキーマと同期され、マイグレーション履歴には2つのマイグレーションが含まれます。

```
migrations/
└─ 20210313140442_init/
└─ migration.sql
└─ 20210313140442_added_job_title/
└─ migration.sql
```

これで、ソース管理し、テスト環境や本番環境へのデプロイに使用できるマイグレーション履歴ができました。

-----

## 🏗️ 既存のプロジェクトにPrisma Migrateを追加する

既存のデータベース（既にデータがあり、リセットできない本番環境など）にPrisma Migrateを導入する手順は以下の通りです。

1.  データベースをイントロスペクトしてPrismaスキーマを更新する
2.  **ベースラインマイグレーション**を作成する
3.  Prisma Schema Languageでサポートされていない機能に対応するため、スキーマまたはマイグレーションを更新する
4.  ベースラインマイグレーションを適用する
5.  マイグレーション履歴とPrismaスキーマをコミットする

### 1\. Prismaスキーマを作成または更新するためにイントロスペクトする

Prismaスキーマが既存のデータベーススキーマと同期していることを確認するために、データベースをイントロスペクトします。

```bash
prisma db pull
```

### 2\. ベースラインマイグレーションを作成する

**ベースライニング**とは、Prisma Migrateを使い始める前から存在し、リセットできないデータベースに対して、マイグレーション履歴を初期化するプロセスです。これにより、既に存在するテーブルやフィールドを再作成しようとする失敗を防ぎます。

ベースラインマイグレーションを作成するには：

1.  `prisma/migrations` フォルダがある場合は、削除、移動、名前の変更、またはアーカイブしてください。

2.  以下のコマンドを実行し、好みの名前で `migrations` ディレクトリを作成します。（例: `0_init`）

    ```bash
    mkdir -p prisma/migrations/0_init
    ```

    > **⚠️ 注意**
    > `0_` は重要です。なぜなら、Prisma Migrateは[辞書順](https://www.google.com/search?q=https://www.prisma.io/docs/orm/prisma-migrate/understanding-prisma-migrate%23lexicographical-order)でマイグレーションを適用するからです。

3.  `prisma migrate diff` を使用してマイグレーションを生成し、ファイルに保存します。

    ```bash
    npx prisma migrate diff \
      --from-empty \
      --to-schema-datamodel prisma/schema.prisma \
      --script > prisma/migrations/0_init/migration.sql
    ```

4.  生成されたマイグレーションを確認します。

### 3\. Prisma Schema Languageでサポートされていない機能への対応

既存のデータベースにある、Prisma Schema Languageでは直接サポートされていない機能を含めるには、初期マイグレーションのSQLを修正します。

  * 生成された `migration.sql` ファイルを開きます。
  * **変更が軽微な場合**：生成されたSQLに追加のカスタムSQLを追記できます。
    ```sql
    /* Generated migration SQL */
    CREATE UNIQUE INDEX tests_success_constraint ON posts (subject, target)
    WHERE success;
    ```
    (例: 部分インデックスの作成)
  * **変更が大幅な場合**：マイグレーションファイル全体をデータベースダンプ（`mysqldump` や `pg_dump`）の結果に置き換える方が簡単な場合があります。

> **ℹ️ 情報**
> 外部キーは同じステップで作成されるため、全てのテーブルを一度に作成する場合、テーブルの順序が重要です。`can't create constraint` のエラーを避けるために、テーブルの順序を並べ替えるか、すべてのテーブルが作成された後で制約の作成を最後のステップに移動してください。

### 4\. 初期マイグレーションを適用する

初期マイグレーションを適用し、Prisma Migrateに「このマイグレーションは既にデータベースに適用済みである」と認識させます。

```bash
npx prisma migrate resolve --applied 0_init
```

データベーススキーマをレビューし、マイグレーションが望ましい最終状態になることを確認します（例：本番データベースとスキーマを比較する）。

これにより、新しいマイグレーション履歴とデータベーススキーマは、Prismaスキーマと同期されます。

### 5\. マイグレーション履歴とPrismaスキーマをコミットする

以下をソース管理にコミットします。

  * マイグレーション履歴フォルダ全体
  * `schema.prisma` ファイル

-----

## ➡️ さらに進む

  * 本番環境へのマイグレーションのデプロイの詳細については、[Deploying database changes with Prisma Migrate](https://www.google.com/search?q=https://www.prisma.io/docs/orm/prisma-migrate/workflows/deployment)ガイドを参照してください。
  * 本番環境での失敗したマイグレーションをデバッグおよび解決する方法については、[Production Troubleshooting](https://www.google.com/search?q=https://www.prisma.io/docs/orm/prisma-migrate/workflows/production-troubleshooting)ガイドを参照してください。

-----