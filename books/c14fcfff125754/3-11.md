---
title: "3-11. Native database functions（ネイティブデータベース関数）"
---

# Native database functions（ネイティブデータベース関数）

PostgreSQLでは、一部のネイティブデータベース関数は**オプションの拡張機能（Extensions）の一部**となっています。例えば、PostgreSQL 12.13以前のバージョンでは、`gen_random_uuid()` 関数は `pgcrypto` 拡張機能の一部です。

PostgreSQLの拡張機能を使用するには、まずデータベースサーバーのファイルシステムにそれをインストールし、次に**拡張機能を有効化**する必要があります。Prisma Migrateを使用する場合、この有効化は**マイグレーションの一部**として行う必要があります。

> **⚠️ 警告:**
> Prisma Migrateを使用している場合、マイグレーションファイルの**外で**拡張機能を有効化しないでください。シャドウデータベースにも同じ拡張機能が必要ですが、Prisma Migrateがシャドウデータベースを自動的に作成・削除するため、拡張機能を有効化する唯一の方法は、**マイグレーションファイルにそれを含めること**です。

## 💡 PostgreSQL拡張機能の有効化方法

### 🆕 バージョン 4.5.0 以降 (Prisma Schemaを使用)

Prisma ORMのバージョン 4.5.0以降では、`postgresqlExtensions` プレビュー機能を使用して、Prismaスキーマ内で拡張機能を宣言することで有効化できます。

```prisma
schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgcrypto] // ← ここで拡張機能を宣言
}
```

この変更は、Prisma Migrateを使用してデータベースに適用できます。

### 🔄 以前のバージョンまたは手動での対応 (SQLを使用)

Prisma ORMの以前のバージョンでは、拡張機能を有効化するために、マイグレーションファイルにSQLコマンドを**手動で追加**する必要がありました。

以下の例は、`pgcrypto` 拡張機能をマイグレーションの一部としてインストールする方法を示しています。

1.  **スキーマに関数を持つフィールドを追加する:**
    ネイティブデータベース関数を持つフィールドをスキーマに追加します。

    ```prisma
    model User {
      id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
    }
    ```

    > **💡 注意:** キャスト演算子（例: `::TEXT`）を含める場合は、関数全体を括弧で囲む必要があります。（例: `@default(dbgenerated("(gen_random_uuid()::TEXT)"))`）

2.  **`--create-only` フラグ**を使用して、マイグレーションを適用せずに**生成**します。

    ```bash
    npx prisma migrate dev --create-only
    ```

3.  生成された **`migration.sql` ファイルを開き**、`pgcrypto` モジュールを有効化するSQLを追加します。

    ```sql
    CREATE EXTENSION IF NOT EXISTS pgcrypto;

    -- その後に、Prismaによって生成されたSQLが続く
    ADD COLUMN "id" UUID NOT NULL DEFAULT gen_random_uuid(),
    ADD PRIMARY KEY ("id");
    ```

4.  マイグレーションを**適用**します。

    ```bash
    npx prisma migrate dev
    ```

これにより、データベースをリセットしたり、新しいチームメンバーが参加したりするたびに、必要なすべての関数がマイグレーション履歴の一部として確実に利用されます。
