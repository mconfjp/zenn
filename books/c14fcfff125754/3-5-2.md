---
title: "3-5-2. Generating down migrations（ダウンマイグレーションの生成）"
---

# Generating down migrations（ダウンマイグレーションの生成）

このガイドでは、特定のマイグレーションファイルを**元に戻す（逆にする）SQLファイル、すなわちダウンマイグレーション**を生成する方法について説明します。

## 🔄 ダウンマイグレーションについて

マイグレーションSQLファイル（**アップマイグレーション**）を生成する際、対応するアップマイグレーションのスキーマ変更を元に戻す（逆にする）**ダウンマイグレーション**SQLファイルも作成したい場合があります。（ダウンマイグレーションは「マイグレーションのロールバック」とも呼ばれます。）

このガイドでは、Prisma Migrateの **`migrate diff`** コマンドを使用してダウンマイグレーションを作成する方法、そしてアップマイグレーションが失敗した場合に **`db execute`** コマンドを使用してそれを本番データベースに適用する方法を説明します。

> **⚠️ 警告:**
> このガイドは、**リレーショナルデータベース向けのSQLダウンマイグレーションの生成にのみ適用**されます。MongoDBには適用されません。

> **ℹ️ 情報:**
> `migrate diff` と `db execute` コマンドは、バージョン 3.9.0 以降でプレビューとして、バージョン 3.13.0 以降で一般提供されています。

### 考慮事項

ダウンマイグレーションファイルを生成する際には、いくつかの考慮事項があります。

  * **失敗したマイグレーションからの復元:** ダウンマイグレーションは、**失敗したマイグレーションの後**にデータベーススキーマを元に戻すために使用できます。これには `migrate resolve` コマンドの使用が必要であり、これは**失敗したマイグレーションにのみ使用可能**です。
  * **成功したマイグレーションの取り消し:** アップマイグレーションが**成功した場合**に元に戻したい場合は、代わりに `schema.prisma` ファイルをアップマイグレーション前の状態に戻し、`migrate dev` コマンドで**新しいマイグレーションを生成**する必要があります。
  * **データの変更やアプリケーションコードの変更は元に戻らない:** ダウンマイグレーションはデータベーススキーマを元に戻しますが、アップマイグレーションの一部として実行された**データやアプリケーションコードの変更は元に戻りません**。（例：マイグレーション中にデータを変更するスクリプトがあった場合、ダウンマイグレーションを実行してもデータは元に戻りません。）
  * **カスタムSQLの取り扱い:** `migrate diff` を使用して、マイグレーションファイル内で**手動で変更または追加されたカスタムSQLを元に戻す**ことはできません。カスタムな追加（例：ビューやトリガー）がある場合は、以下の手順が必要です。
    1.  以下の手順に従ってダウンマイグレーションを作成する。
    2.  `migrate dev --create-only` を使用してアップマイグレーションを作成し、データベースに適用する前に編集できるようにする。
    3.  アップマイグレーションにカスタムSQLを**手動で追加**する（例：ビューの追加）。
    4.  ダウンマイグレーションに**反転させたカスタムSQLを**手動で追加する（例：ビューの削除）。

-----

## ⚙️ ダウンマイグレーションの生成と実行方法

ここでは、対応するアップマイグレーションと共にダウンマイグレーションSQLファイルを生成し、本番環境でアップマイグレーションが失敗した後にそれを実行してデータベーススキーマを元に戻す方法を説明します。

### 1\. マイグレーションの生成

#### **スキーマの変更**

まず、アップマイグレーションで必要な変更をPrismaスキーマに加えます。（例：新しい `Profile` モデルを追加します。）

#### **ダウンマイグレーションSQLファイルの生成**

対応するアップマイグレーションを作成する**前に**、ダウンマイグレーション用のSQLファイルを生成する必要があります。これには `migrate diff` を使用して比較を行います。

**比較元 (`--from-schema-datamodel`)**: **新しく編集されたスキーマ**の状態
**比較先 (`--to-migrations` または `--to-schema-datasource`)**: **最後のマイグレーション後のスキーマ**の状態

これをSQLスクリプト `down.sql` に出力します。

**オプション 1: マイグレーション履歴と比較する (推奨)**

  * **`--to-migrations`** を使用します。これはより堅牢ですが、シャドウデータベースが必要です。
  * 実行コマンド:
    ```bash
    npx prisma migrate diff \
      --from-schema-datamodel prisma/schema.prisma \
      --to-migrations prisma/migrations \
      --shadow-database-url $SHADOW_DATABASE_URL \
      --script > down.sql
    ```

**オプション 2: データベースと比較する**

  * **`--to-schema-datasource`** を使用します。シャドウデータベースは不要ですが、データベースが最新のスキーマであることを前提としています。
  * 実行コマンド:
    ```bash
    npx prisma migrate diff \
      --from-schema-datamodel prisma/schema.prisma \
      --to-schema-datasource prisma/schema.prisma \
      --script > down.sql
    ```

#### **アップマイグレーションの生成と適用**

`add_profile` という名前でアップマイグレーションを生成し、適用します。

```bash
npx prisma migrate dev --name add_profile
```

これにより、`prisma/migrations` ディレクトリ内に新しい `<timestamp>_add_profile` ディレクトリが作成され、その中に新しいアップマイグレーションファイル `migration.sql` が含まれます。

#### **ファイルの配置**

生成された `down.sql` ファイルを、アップマイグレーションファイルと一緒に**新しいマイグレーションディレクトリ内にコピー**します。

### 2\. 失敗したマイグレーションへのダウンマイグレーションの適用

以前のアップマイグレーションが**失敗した**場合、以下の手順でダウンマイグレーションを本番データベースに適用できます。

1.  **`db execute`** を使用して、`down.sql` ファイルをデータベースサーバーで実行します。

    ```bash
    npx prisma db execute --file ./down.sql --schema prisma/schema.prisma
    ```

2.  **`migrate resolve`** を使用して、`add_profile` という名前のアップマイグレーションを**ロールバックした**ことを記録します。

    ```bash
    npx prisma migrate resolve --rolled-back add_profile
    ```
