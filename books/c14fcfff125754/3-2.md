---
title: "3-2. Prototyping your schema"
---

# Prototyping your schema（スキーマのプロトタイピング）

Prisma CLIには、スキーマのプロトタイピング専用のコマンド、**`db push`** が用意されています。

`db push` はPrisma Migrateと同じエンジンを使用して、Prismaスキーマとデータベーススキーマを同期します。`db push` コマンドは以下のことを行います。

  * データベースを**イントロスペクト**し、データベーススキーマをPrismaスキーマの状態に一致させるために必要な変更を推論し、実行します。
  * データベーススキーマに変更が適用された後、デフォルトでジェネレーター（例：Prisma Client）がトリガーされます。**`prisma generate` を手動で呼び出す必要はありません**。

`db push` が変更によって**データ損失**が発生する可能性があると予測した場合、以下のいずれかを実行します。

  * エラーをスローします。
  * それでも変更を行いたい場合は、**`--accept-data-loss`** オプションを要求します。

> **📝 注意事項**
>
>   * `db push` はマイグレーションと連携したり、依存したりしません。`_prisma_migrations` テーブルは作成・更新されず、マイグレーションファイルも生成されません。
>   * PlanetScaleで作業する場合、`migrate` の代わりに `db push` の使用を推奨します。詳細については、「Getting Started」のドキュメント（「Start from scratch」または「Add to existing project」）を参照してください。

-----

## 🆚 `db push` または Prisma Migrateの選択

`db push` は以下のような場合に適しています。

  * 他の開発者やステージング、本番環境など、**他の環境にこれらの変更をデプロイする必要がない**、ローカルでのスキーマ設計のプロトタイピングと迅速なイテレーション（反復）を行いたい場合。
  * 変更を適用して最終的な状態に到達することを優先し、**その最終状態に到達するために実行された変更や手順（履歴）を気にしない**場合。（`db push` による変更をプレビューする方法はありません。）
  * スキーマの変更がデータに与える影響を制御する必要がない場合。スキーマとデータのマイグレーションを調整する方法はありません。`db push` がデータ損失につながる可能性があると予測した場合、`--accept-data-loss` オプションでデータ損失を受け入れるか、プロセスを停止するかのどちらかになります。
  * 変更を**カスタマイズする必要がない**場合。

`db push` は以下のような場合には**推奨されません**。

  * データを失うことなく、**他の環境でスキーマ変更を再現したい**場合。プロトタイピングには `db push` を使用できますが、スキーマ変更をコミットし、他の環境に適用するにはマイグレーションを使用する必要があります。
  * スキーマ変更がどのように実行されるかについて、**きめ細かな制御**を行いたい場合。例えば、カラムを削除して新しく作成するのではなく、カラム名を変更したい場合などです。
  * データベーススキーマに加えられた変更を**時間の経過とともに追跡したい**場合。`db push` はこれらの変更を追跡するための成果物を生成しません。
  * スキーマ変更を**元に戻せるようにしたい**場合。`db push` を再度使用して元の状態に戻すことは可能ですが、データ損失につながる可能性があります。

-----

## 🤝 Prisma Migrateと`db push`を一緒に使用できますか？

はい、開発ワークフローで `db push` と Prisma Migrateを**一緒に使用できます**。例えば、以下のような使い方ができます。

  * プロジェクトの開始時に `db push` を使用してスキーマをプロトタイプし、最初のドラフトに満足した時点で**マイグレーション履歴を初期化する**。
  * 既存のスキーマに対する変更をプロトタイプするために `db push` を使用し、その後 `prisma migrate dev` を実行して、その変更からマイグレーションを生成する。（この際、リセットを求められます。）

-----

## 🆕 新しいスキーマのプロトタイピング

このシナリオは、`db push` を使用して新しいスキーマを空のデータベースと同期させ、そのスキーマを進化させる方法、および `db push` がデータ損失につながる変更を検出した場合にどうなるかを示しています。

1.  **スキーマの最初のドラフトを作成する:**
    `schema.prisma` ファイルに初期のモデルを定義します。

2.  **`db push` を使用して初期スキーマをデータベースにプッシュする:**

    ```bash
    npx prisma db push
    ```

3.  **いくつかのサンプルコンテンツを作成する:**
    Prisma Clientを使用して、データベースにテストデータを挿入します。

4.  **追加の変更を行う:**
    例として、`Post` モデルに新しい必須フィールド (`description`：説明) を追加します。

5.  **変更をプッシュする:**

    ```bash
    npx prisma db push
    ```

    既存のコンテンツを持つテーブルにデフォルト値なしで必須フィールドを追加することはできないため、`db push` は**失敗**します。

6.  **すべてのデータをリセットし、マイグレーションを再適用する:**

    ```bash
    npx prisma migrate reset
    ```

> **📝 注意:**
> Prisma Migrateとは異なり、`db push` はデータを保持するために変更できるマイグレーションを生成しません。したがって、`db push` は**開発環境でのプロトタイピングに最も適しています**。

7.  **スキーマが比較的安定した状態になるまで進化させ続ける。**

8.  **マイグレーション履歴を初期化する:**

    ```bash
    npx prisma migrate dev --name initial-state
    ```

    初期のプロトタイプに到達するために行われた手順は保持されません。`db push` は履歴を生成しないからです。

9.  **マイグレーション履歴とPrismaスキーマをソース管理（例：Git）にコミットする。**
    この時点で、プロトタイピングの最終ドラフトはマイグレーションとして保持され、他の環境（テスト、本番、または他のチームメンバー）にプッシュできるようになります。

-----

## 🔄 既存のマイグレーション履歴を持つプロトタイピング

このシナリオは、マイグレーション履歴が既に存在する場合に、`db push` を使用してPrismaスキーマへの変更をプロトタイプする方法を示しています。

1.  **最新のPrismaスキーマとマイグレーション履歴をチェックアウトする。**

2.  **新しい機能のプロトタイプを作成する。**
    これには、任意の数の手順が含まれる可能性があります。例えば、以下の操作を繰り返すかもしれません。

      * `tags String[]` フィールドを作成し、`db push` を実行する。
      * フィールドタイプを `tags Tag[]` に変更し、新しい `Tag` モデルを追加し、`db push` を実行する。
      * 気を改めて、元の `tags String[]` フィールドに戻し、`db push` を呼び出す。
      * データベースで `tags` フィールドに手動で変更を加える（例：制約を追加する）。

3.  **最終的なスキーマ変更を決定する。**
    例えば、プロトタイピングを繰り返した結果、最終的なスキーマ変更が `Post` モデルへの新しい `tags` フィールドの追加になったとします。

4.  **`migrate dev` コマンドを実行してマイグレーションを作成する。**

    ```bash
    npx prisma migrate dev --name added-tags
    ```

    プロトタイピング中に行った手動での変更や `db push` による変更はマイグレーション履歴の一部ではないため、Prisma Migrateは**リセットを促します**。

    > `√ Drift detected: Your database schema is not in sync with your migration history. We need to reset the PostgreSQL database "prototyping" at "localhost:5432". warning This will result in total data loss.`

    Prisma Migrateは既存のマイグレーション履歴をリプレイし、スキーマ変更に基づいて新しいマイグレーションを生成し、それらの変更をデータベースに適用します。

    > **💡 ヒント**
    > `migrate dev` を使用する際、スキーマの変更によってシードスクリプトが機能しなくなる場合は、`--skip-seed` フラグを使用してシードスクリプトを無視できます。

5.  **マイグレーションを他の環境にプッシュする。**
    この時点で、プロトタイピングの最終結果はマイグレーションとして保持され、他の環境（テスト、本番、または他のチームメンバー）にプッシュできます。
